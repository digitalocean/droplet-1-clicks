#!/bin/sh

# Generate unique gateway token for this droplet
if grep -q "PLACEHOLDER_WILL_BE_REPLACED_ON_FIRST_BOOT" /opt/clawdbot.env 2>/dev/null; then
    echo "Generating unique gateway token for this droplet..."
    NEW_GATEWAY_TOKEN=$(openssl rand -hex 32)
    sed -i "s/CLAWDBOT_GATEWAY_TOKEN=PLACEHOLDER_WILL_BE_REPLACED_ON_FIRST_BOOT/CLAWDBOT_GATEWAY_TOKEN=$NEW_GATEWAY_TOKEN/" /opt/clawdbot.env
    echo "Gateway token generated successfully."
    
    # Save token to a file for easy access
    echo "$NEW_GATEWAY_TOKEN" > /home/clawdbot/.clawdbot/gateway-token.txt
    chown clawdbot:clawdbot /home/clawdbot/.clawdbot/gateway-token.txt
    chmod 600 /home/clawdbot/.clawdbot/gateway-token.txt
fi

# Remove the ssh force logout command
sed -e '/Match User root/d' \
    -e '/.*ForceCommand.*droplet.*/d' \
    -i /etc/ssh/sshd_config

cat >> /root/.bashrc <<EOM
chmod +x /etc/clawdbot_setup.sh
/etc/clawdbot_setup.sh
EOM

systemctl restart ssh
