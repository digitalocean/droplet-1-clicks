#!/bin/sh

# Generate unique gateway token for this droplet
if grep -q "PLACEHOLDER_WILL_BE_REPLACED_ON_FIRST_BOOT" /opt/clawdbot.env 2>/dev/null; then
    echo "Generating unique gateway token for this droplet..."
    NEW_GATEWAY_TOKEN=$(openssl rand -hex 32)
    sed -i "s/CLAWDBOT_GATEWAY_TOKEN=PLACEHOLDER_WILL_BE_REPLACED_ON_FIRST_BOOT/CLAWDBOT_GATEWAY_TOKEN=$NEW_GATEWAY_TOKEN/" /opt/clawdbot.env
    echo "Gateway token generated successfully."
    
    # Save token to a file for easy access
    echo "$NEW_GATEWAY_TOKEN" > /home/clawdbot/.clawdbot/gateway-token.txt
    chown clawdbot:clawdbot /home/clawdbot/.clawdbot/gateway-token.txt
    chmod 600 /home/clawdbot/.clawdbot/gateway-token.txt
fi

# Replace PLACEHOLDER_DOMAIN in Caddyfile with actual IP address
meta() { curl -fsS --retry 10 --retry-connrefused --max-time 2 "$1"; }
DROPLET_IP="$(meta http://169.254.169.254/metadata/v1/interfaces/public/0/ipv4/address 2>/dev/null || true)"

if grep -q "PLACEHOLDER_DOMAIN" /etc/caddy/Caddyfile 2>/dev/null; then
    echo "Configuring Caddy with droplet IP address..."
    sed -i "s/PLACEHOLDER_DOMAIN/$DROPLET_IP/" /etc/caddy/Caddyfile
    systemctl enable caddy
fi


# Remove the ssh force logout command
sed -e '/Match User root/d' \
    -e '/.*ForceCommand.*droplet.*/d' \
    -i /etc/ssh/sshd_config

systemctl restart ssh
systemctl restart clawdbot
systemctl restart caddy
