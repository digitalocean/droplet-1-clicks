#!/bin/sh

# Generate unique gateway token for this droplet
if grep -q "PLACEHOLDER_WILL_BE_REPLACED_ON_FIRST_BOOT" /opt/clawdbot.env 2>/dev/null; then
    echo "Generating unique gateway token for this droplet..."
    NEW_GATEWAY_TOKEN=$(openssl rand -hex 32)
    sed -i "s/CLAWDBOT_GATEWAY_TOKEN=PLACEHOLDER_WILL_BE_REPLACED_ON_FIRST_BOOT/CLAWDBOT_GATEWAY_TOKEN=$NEW_GATEWAY_TOKEN/" /opt/clawdbot.env
    echo "Gateway token generated successfully."
    
    # Save token to a file for easy access
    echo "$NEW_GATEWAY_TOKEN" > /home/clawdbot/.clawdbot/gateway-token.txt
    chown clawdbot:clawdbot /home/clawdbot/.clawdbot/gateway-token.txt
    chmod 600 /home/clawdbot/.clawdbot/gateway-token.txt
fi

# Remove the ssh force logout command
sed -e '/Match User root/d' \
    -e '/.*ForceCommand.*droplet.*/d' \
    -i /etc/ssh/sshd_config

systemctl restart ssh

# Create minimal Clawdbot config if it doesn't exist
if [ ! -f "/home/clawdbot/.clawdbot/clawdbot.json" ]; then
    echo "Creating minimal Clawdbot configuration..."
    mkdir -p /home/clawdbot/.clawdbot
    cat > /home/clawdbot/.clawdbot/clawdbot.json << 'CONFIGEOF'
{
  "gateway": {
    "mode": "local"
  }
}
CONFIGEOF
    chown clawdbot:clawdbot /home/clawdbot/.clawdbot/clawdbot.json
    chmod 644 /home/clawdbot/.clawdbot/clawdbot.json
fi

# Start the Clawdbot service
echo "Starting Clawdbot Gateway service..."
systemctl start clawdbot

# Wait for service to start
sleep 3

# Display status
if systemctl is-active --quiet clawdbot; then
    echo "✅ Clawdbot Gateway started successfully!"
else
    echo "⚠️  Clawdbot service may need configuration. Check with: systemctl status clawdbot"
fi
