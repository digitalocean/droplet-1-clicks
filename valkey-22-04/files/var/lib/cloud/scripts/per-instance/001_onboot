#!/bin/sh

# Remove the ssh force logout command
sed -e '/Match User root/d' \
    -e '/.*ForceCommand.*droplet.*/d' \
    -i /etc/ssh/sshd_config

systemctl restart ssh

# Generate root password for Valkey
admin_valkey_pass=$(openssl rand -hex 32)

# Generate password file
cat > /root/.digitalocean_passwords << EOM
valkey_password="${admin_valkey_pass}"
EOM

chmod 600 /root/.digitalocean_passwords

# Update valkey configuration with the generated password
sed -i "s/requirepass .*/requirepass ${admin_valkey_pass}/" /etc/valkey/valkey.conf

# Get droplet IP and add binding (optional - for external access)
droplet_ip=$(hostname -I | awk '{print$1}') 
# Uncomment the next line if you want to bind to droplet IP for external access
# sed -i "s/bind 127.0.0.1/bind 127.0.0.1 ${droplet_ip}/" /etc/valkey/valkey.conf

# Restart valkey service
systemctl restart valkey
